<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEPPL AI</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-search-components.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- JavaScript Files -->
    <script src="{{ url_for('static', filename='js/professional-content-renderer.js') }}?v=1.3.0" defer></script>
    <script src="{{ url_for('static', filename='js/integrated-search-bar.js') }}?v=pro120" defer></script>
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
    <script>window.pdfjsLib && (pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js');</script>
    
    <!-- Meta tags for better SEO and social sharing -->
    <meta name="description" content="TEPPL AI - Traffic Engineering Assistant for policies, practices, and legal authority documents">
    <meta name="keywords" content="traffic engineering, MUTCD, intersection design, signal timing, NCDOT">
    <meta name="author" content="TEPPL AI">
    
    <!-- Open Graph meta tags -->
    <meta property="og:title" content="TEPPL AI - Traffic Engineering Assistant">
    <meta property="og:description" content="Ask questions about Traffic Engineering policies, practices, and legal authority documents">
    <meta property="og:type" content="website">
</head>
<body>
    <!-- App Header -->
    <div class="app-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">T</div>
                <div class="logo-text">
                    <h1>TEPPL AI</h1>
                    <p>Traffic Engineering Assistant</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="theme-toggle">
                    üåô Dark
                </button>
                <button class="header-btn" id="system-info-btn">
                    üìä System Info
                </button>
            </div>
        </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="main-grid">
        <!-- Left Pane - Enhanced History and Quick Actions -->
        <div id="history-pane" class="pane">
            <div class="pane-header">
                <h2>Search History</h2>
                <button id="clear-history" class="clear-btn" title="Clear search history">Clear</button>
            </div>
            
            <div class="history-content">
                <!-- Enhanced History Search -->
                <div class="history-search-container">
                    <input 
                        type="text" 
                        id="history-search" 
                        class="history-search-input" 
                        placeholder="Search history..." 
                        autocomplete="off"
                        spellcheck="false"
                    />
                </div>
                
                <!-- Enhanced History Results -->
                <div id="history-search-results" class="history-search-results">
                    <!-- Dynamic history search results will be inserted here -->
                </div>
                
                <!-- Original History List (fallback) -->
                <ul class="history-list" id="search-history-list" style="display: none;">
                    <!-- Dynamic history items will be inserted here by legacy code -->
                </ul>
            </div>
            
            <!-- Enhanced Quick Actions Section -->
            <div class="quick-actions">
                <h3>Quick Actions</h3>
                
                <!-- Enhanced Quick Actions Interface -->
                <div class="quick-actions-enhanced">
                    <input 
                        type="text" 
                        id="quick-actions-search" 
                        class="quick-actions-search-input" 
                        placeholder="Search actions..." 
                        autocomplete="off"
                        spellcheck="false"
                    />
                    <button 
                        id="add-custom-action" 
                        class="add-custom-action-btn"
                        title="Add a new custom action"
                    >
                        + Add Custom Action
                    </button>
                    <div id="custom-actions-list" class="custom-actions-list">
                        <!-- Dynamic custom actions will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Pane - Main Interface -->
        <div id="content-pane" class="pane">
            <div class="content-area">
                <!-- Answer Container -->
                <div class="answer-container" id="answer-container">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcome-screen">
                        <div class="welcome-content">
                            <div class="welcome-icon">üõë</div>
                            <h2>Welcome to TEPPL AI</h2>
                            <p>Ask questions about Traffic Engineering policies, practices, and legal authority documents.</p>
                            
                            <!-- Enhanced Status Overview -->
                            <div class="status-overview">
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div>{{ system_type|title if system_type else 'Unknown' }}</div>
                                        <div>Mode</div>
                                    </div>
                                    <div class="status-item">
                                        <div>{{ real_counts.images if real_counts else image_stats.kept_images if image_stats else 0 }}</div>
                                        <div>Images</div>
                                    </div>
                                    <div class="status-item">
                                        <div>{{ real_counts.documents if real_counts else 25 }}</div>
                                        <div>Documents</div>
                                    </div>
                                    <div class="status-item">
                                        <div>{{ real_counts.text_chunks if real_counts else 0 }}</div>
                                        <div>Text Chunks</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Suggestion Cards -->
                            <div class="suggestion-cards">
                                <div class="suggestion-card" data-query="MUTCD sign requirements and placement guidelines" tabindex="0" role="button">
                                    <i>üõë</i>
                                    <div>
                                        <h4>MUTCD Standards</h4>
                                        <p>Sign requirements & placement</p>
                                    </div>
                                </div>
                                <div class="suggestion-card" data-query="Signal timing plans and procedures" tabindex="0" role="button">
                                    <i>üö¶</i>
                                    <div>
                                        <h4>Signal Timing</h4>
                                        <p>Timing plans & procedures</p>
                                    </div>
                                </div>
                                <div class="suggestion-card" data-query="Intersection geometric design standards" tabindex="0" role="button">
                                    <i>‚ö°</i>
                                    <div>
                                        <h4>Intersection Design</h4>
                                        <p>Geometric standards</p>
                                    </div>
                                </div>
                                <div class="suggestion-card" data-query="Show me technical drawings and diagrams" tabindex="0" role="button">
                                    <i>üìê</i>
                                    <div>
                                        <h4>Technical Drawings</h4>
                                        <p>Visual examples & diagrams</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Conversation Container -->
                    <div class="conversation" id="conversation" style="display: none;">
                        <!-- Messages will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Enhanced Input Container with Integrated Search Options -->
                <div class="input-container">
                    <!-- Integrated Search Options -->
                    <div id="search-options-integrated" class="search-options-integrated">
                        <button 
                            type="button" 
                            class="search-option-toggle" 
                            data-option="images" 
                            aria-pressed="false"
                            title="Include images in search results"
                        >
                            <span class="toggle-icon">üñºÔ∏è</span>
                            <span class="toggle-text">Include images in search</span>
                        </button>
                        <button 
                            type="button" 
                            class="search-option-toggle" 
                            data-option="drawings" 
                            aria-pressed="false"
                            title="Include technical drawings in search results"
                        >
                            <span class="toggle-icon">üìê</span>
                            <span class="toggle-text">Include technical drawings</span>
                        </button>
                    </div>

                    <!-- Enhanced Query Form -->
                    <form id="query-form" class="query-form" role="search">
                        <div class="input-group">
                            <textarea 
                                id="query-input" 
                                name="query"
                                placeholder="Ask about traffic engineering policies, standards, or procedures..."
                                rows="1"
                                maxlength="2000"
                                autocomplete="off"
                                spellcheck="true"
                                aria-label="Enter your question about traffic engineering"
                                required
                            ></textarea>
                            <button 
                                type="submit" 
                                id="send-btn" 
                                class="send-btn" 
                                disabled
                                aria-label="Send query"
                                title="Send your question (or press Enter)"
                            >
                                <span aria-hidden="true">‚Üí</span>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Enhanced Input Footer -->
                    <div class="input-footer">
                        <p class="disclaimer">
                            AI-generated answers may contain errors. Always verify with official NCDOT policies.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Pane - Enhanced Visual Results -->
        <div id="image-pane" class="pane {% if not multimodal_available %}hidden{% endif %}">
            <div class="pane-header">
                <h2>Visual Results</h2>
                <button id="clear-visuals" class="clear-btn" title="Clear visual results">Clear</button>
            </div>
            
            <div class="image-panel">
                <!-- Enhanced Image Placeholder -->
                <div class="image-placeholder" id="image-placeholder">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üñºÔ∏è</div>
                    <p>Images and diagrams will appear here when found in search results</p>
                    <p><em>Enable "Include images in search" to see visual content</em></p>
                </div>
                
                <!-- Enhanced Image Results Container -->
                <div id="image-results" class="image-results" style="display: none;">
                    <div class="image-results-header">
                        <h3>Related Images & Diagrams</h3>
                        <div class="image-results-count" id="image-results-count"></div>
                    </div>
                    <div class="image-grid" id="image-grid">
                        <!-- Dynamic image results will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Autocomplete Dropdown -->
    <div id="autocomplete-dropdown" class="autocomplete-dropdown" style="display: none;" role="listbox">
        <div id="autocomplete-list" class="autocomplete-list">
            <!-- Dynamic autocomplete suggestions will be inserted here -->
        </div>
    </div>

    <!-- System Info Modal -->
    <div id="system-info-modal" class="modal-overlay">
        <div class="modal-container" style="width: 600px; height: auto; max-height: 80vh;">
            <div class="modal-header">
                <h3>System Information</h3>
                <button id="close-system-info" class="modal-close">√ó</button>
            </div>
            <div class="modal-content" style="padding: var(--space-16); overflow-y: auto;">
                <div id="system-info-content">
                    <p>Loading system information...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div class="modal-overlay" id="document-modal" role="dialog" aria-labelledby="document-modal-title" aria-hidden="true">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="document-modal-title">Document Viewer</h3>
                <button class="modal-close" id="close-document-modal" aria-label="Close document viewer">&times;</button>
            </div>
            
            <!-- Enhanced PDF Container -->
            <div id="pdf-container" class="pdf-container" style="display: none;">
                <!-- Enhanced PDF Toolbar -->
                <div class="pdf-toolbar" id="pdf-toolbar">
                    <div class="pdf-controls">
                        <button class="pdf-btn" id="pdf-prev" aria-label="Previous page" title="Previous page">‚Äπ</button>
                        <div class="page-info" id="page-info" role="status" aria-live="polite">1 / 1</div>
                        <button class="pdf-btn" id="pdf-next" aria-label="Next page" title="Next page">‚Ä∫</button>
                    </div>
                    <div class="pdf-zoom-controls">
                        <button class="pdf-btn" id="pdf-zoom-out" aria-label="Zoom out" title="Zoom out">‚àí</button>
                        <span id="pdf-zoom-level">100%</span>
                        <button class="pdf-btn" id="pdf-zoom-in" aria-label="Zoom in" title="Zoom in">+</button>
                    </div>
                </div>
                
                <!-- Enhanced PDF Canvas -->
                <canvas id="pdf-canvas" role="img"></canvas>
            </div>
            
            <!-- Enhanced PDF Viewer -->
            <div class="pdf-viewer" id="pdf-viewer">
                <div class="loading-indicator">
                    <p>Loading document...</p>
                </div>
                <div class="pdf-error" id="pdf-error" style="display: none;" role="alert">
                    <h4>Unable to load document</h4>
                    <p>Please check the console for details or try refreshing the page.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Image Viewer Modal -->
    <div class="modal-overlay" id="image-modal" role="dialog" aria-labelledby="image-modal-title" aria-hidden="true">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="image-modal-title">Image Viewer</h3>
                <button class="modal-close" id="close-image-modal" aria-label="Close image viewer">&times;</button>
            </div>
            <div class="image-modal-content" id="image-modal-content">
                <!-- Image will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Enhanced Custom Action Modal -->
    <div class="modal-overlay" id="custom-action-modal" role="dialog" aria-labelledby="custom-action-modal-title" aria-hidden="true">
        <div class="modal-container" style="width: 500px; height: auto;">
            <div class="modal-header">
                <h3>Add Custom Action</h3>
                <button id="close-modal" class="modal-close" type="button">√ó</button>
            </div>
            <div class="modal-content" style="padding: var(--space-16);">
                <form id="custom-action-form">
                    <div class="form-group" style="margin-bottom: var(--space-12);">
                        <label for="action-name" style="display: block; margin-bottom: var(--space-4); font-weight: var(--font-weight-medium);">Action Name</label>
                        <input type="text" id="action-name" class="form-input" style="width: 100%; padding: var(--space-8); border: 1px solid var(--color-border); border-radius: var(--radius-base);" placeholder="e.g., Traffic Signs" required>
                    </div>
                    <div class="form-group" style="margin-bottom: var(--space-16);">
                        <label for="action-query" style="display: block; margin-bottom: var(--space-4); font-weight: var(--font-weight-medium);">Query</label>
                        <input type="text" id="action-query" class="form-input" style="width: 100%; padding: var(--space-8); border: 1px solid var(--color-border); border-radius: var(--radius-base);" placeholder="e.g., MUTCD sign requirements" required>
                    </div>
                    <div id="form-error" class="form-error" style="display: none;"></div>
                    <div class="form-actions" style="display: flex; gap: var(--space-8); justify-content: flex-end;">
                        <button type="button" id="cancel-action" style="padding: var(--space-8) var(--space-16); background: var(--color-secondary); border: 1px solid var(--color-border); border-radius: var(--radius-base); cursor: pointer;">Cancel</button>
                        <button type="submit" style="padding: var(--space-8) var(--space-16); background: var(--color-primary); color: var(--color-btn-primary-text); border: none; border-radius: var(--radius-base); cursor: pointer;">Add Action</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Enhanced Error Handling and Session Management -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Initializing TEPPL AI Enhanced Features...');

      // Enhanced global error handler
      window.addEventListener('error', (event) => {
        console.error('üí• Global error:', event.error);
        if (event.error && event.error.message && 
            !event.error.message.includes('ResizeObserver') &&
            !event.error.message.includes('Non-Error promise rejection')) {
          if (event.error.message.includes('fetch') || 
              event.error.message.includes('network') ||
              event.error.message.includes('server')) {
            const conversation = document.getElementById('conversation');
            if (conversation && conversation.style.display !== 'none') {
              console.error('Critical error occurred:', event.error.message);
              // Show user-friendly error message
              if (window.searchBar && typeof window.searchBar.displayError === 'function') {
                window.searchBar.displayError('Network connection issue. Please try again.');
              }
            }
          }
        }
      });

      // Enhanced unhandled promise rejection handler
      window.addEventListener('unhandledrejection', (event) => {
        console.error('üí• Unhandled promise rejection:', event.reason);
        if (event.reason && event.reason.toString().includes('fetch')) {
          console.error('Network-related promise rejection:', event.reason);
          // Prevent default browser handling
          event.preventDefault();
        }
      });

      // Enhanced user interaction tracking and session management
      let userInteractionCount = 0;
      ['click', 'keydown', 'input'].forEach(eventType => {
        document.addEventListener(eventType, () => {
          userInteractionCount++;
          if (userInteractionCount === 10) {
            console.log('üë§ User is actively engaged');
          }
        }, { once: false, passive: true });
      });

      const sessionStart = new Date().toISOString();
      sessionStorage.setItem('teppl_session_start', sessionStart);
      
      window.addEventListener('beforeunload', () => {
        const sessionDuration = Date.now() - new Date(sessionStart).getTime();
        console.log('üìä Session duration:', Math.round(sessionDuration / 1000), 'seconds');
        console.log('üìä User interactions:', userInteractionCount);
        
        // Store session analytics
        try {
          const sessionData = {
            duration: Math.round(sessionDuration / 1000),
            interactions: userInteractionCount,
            timestamp: sessionStart,
            endTime: new Date().toISOString()
          };
          localStorage.setItem('teppl_last_session', JSON.stringify(sessionData));
        } catch (e) {
          console.warn('Could not save session data:', e);
        }
      });

      console.log('‚úÖ Enhanced error handling and session management initialized');
    });
  </script>

    <!-- Working Search Bar Implementation -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing TEPPL AI...');

            // Working Search Bar Manager - ENHANCED WITH PROFESSIONAL RENDERING
            class SearchBarManager {
                constructor() {
                    this.queryInput = document.getElementById('query-input');
                    this.sendBtn = document.getElementById('send-btn');
                    this.queryForm = document.getElementById('query-form');
                    this.toggles = document.querySelectorAll('.search-option-toggle');
                    this.options = { images: false, drawings: false };
                    
                    // Professional content renderer
                    this.professionalRenderer = null;
                    
                    this.init();
                }

                init() {
                    if (!this.queryInput || !this.sendBtn || !this.queryForm) {
                        console.error('‚ùå Missing required elements for search bar');
                        return;
                    }

                    // Initialize professional renderer
                    this.initializeProfessionalRenderer();

                    // Enable send button when user types
                    this.queryInput.addEventListener('input', () => {
                        this.sendBtn.disabled = this.queryInput.value.trim() === '';
                    });
                    console.log('‚úÖ Input listener added');

                    // Handle toggle buttons
                    this.toggles.forEach(toggle => {
                        toggle.addEventListener('click', () => this.handleToggle(toggle));
                    });
                    console.log('‚úÖ Toggle listeners added');

                    // Handle form submission
                    this.queryForm.addEventListener('submit', (e) => this.handleSubmit(e));
                    console.log('‚úÖ Form listener added');

                    // Handle suggestion cards
                    document.querySelectorAll('.suggestion-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const query = card.dataset.query;
                            if (query) {
                                this.queryInput.value = query;
                                this.sendBtn.disabled = false;
                                this.queryInput.focus();
                            }
                        });
                    });
                    console.log('‚úÖ Suggestion card listeners added');
                }

                initializeProfessionalRenderer() {
                    // Wait for ProfessionalContentRenderer to be available
                    if (window.ProfessionalContentRenderer) {
                        try {
                            this.professionalRenderer = new window.ProfessionalContentRenderer();
                            console.log('‚úÖ Professional Content Renderer integrated with SearchBar');
                            return true;
                        } catch (error) {
                            console.error('‚ùå Failed to initialize Professional Content Renderer:', error);
                            this.professionalRenderer = null;
                            return false;
                        }
                    } else {
                        console.warn('‚ö†Ô∏è ProfessionalContentRenderer not available, retrying...');
                        // Retry after a short delay
                        setTimeout(() => this.initializeProfessionalRenderer(), 100);
                        return false;
                    }
                }

                handleToggle(button) {
                    const option = button.dataset.option;
                    this.options[option] = !this.options[option];
                    button.classList.toggle('active', this.options[option]);
                    button.setAttribute('aria-pressed', this.options[option]);
                    console.log(`üîß Toggle ${option}:`, this.options[option]);
                }

                async handleSubmit(e) {
                    e.preventDefault();
                    const query = this.queryInput.value.trim();
                    if (!query) return;

                    console.log('üì§ Submitting query:', query);
                    console.log('üì§ Options:', this.options);
                    
                    // Show loading state
                    this.sendBtn.innerHTML = '‚è≥';
                    this.sendBtn.disabled = true;

                    try {
                        const response = await fetch('/query', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                query: query,
                                include_images: this.options.images,
                                include_drawings: this.options.drawings
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        console.log('üì• Received response:', data);
                        
                        this.processQueryResponse(data, query);
                        this.saveToHistory(query);

                    } catch (error) {
                        console.error('‚ùå Query failed:', error);
                        this.displayError('Failed to process query: ' + error.message);
                    } finally {
                        this.sendBtn.innerHTML = '<span aria-hidden="true">‚Üí</span>';
                        this.sendBtn.disabled = false;
                    }
                }

                processQueryResponse(data, query) {
                    if (data.success) {
                        // Use professional rendering if available
                        if (this.professionalRenderer && data.presentation_mode === 'professional') {
                            this.displayProfessionalResponse(data, query);
                        } else {
                            this.displayAnswer(data.answer, data.confidence, query);
                            this.displaySources(data.sources || []);
                        }
                        
                        this.displayImages(data.images || []);
                        
                        // Clear the input after successful query
                        this.queryInput.value = '';
                        this.sendBtn.disabled = true;
                    } else {
                        this.displayError(data.error || 'Unknown error occurred');
                    }
                }

                displayProfessionalResponse(data, query) {
                    const conversation = document.getElementById('conversation');
                    const welcomeScreen = document.getElementById('welcome-screen');
                    
                    if (welcomeScreen) welcomeScreen.style.display = 'none';
                    if (!conversation) return;
                    
                    conversation.style.display = 'block';
                    
                    // Create user message
                    const userMessage = this.createUserMessage(query);
                    conversation.appendChild(userMessage);
                    
                    // Create professional assistant message
                    const assistantMessage = this.professionalRenderer.createProfessionalMessage(data);
                    conversation.appendChild(assistantMessage);
                    
                    // Scroll to bottom
                    conversation.scrollTop = conversation.scrollHeight;
                    
                    console.log('üé® Professional response rendered successfully');
                }

                createUserMessage(query) {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message user-message animate-in';
                    
                    const avatarElement = document.createElement('div');
                    avatarElement.className = 'message-avatar';
                    avatarElement.innerHTML = 'üë§';
                    
                    const contentElement = document.createElement('div');
                    contentElement.className = 'message-content';
                    
                    const textElement = document.createElement('div');
                    textElement.className = 'message-text';
                    textElement.textContent = query;
                    
                    contentElement.appendChild(textElement);
                    messageElement.appendChild(avatarElement);
                    messageElement.appendChild(contentElement);
                    
                    return messageElement;
                }

                displayAnswer(answer, confidence, query) {
                    const conversation = document.getElementById('conversation');
                    const welcomeScreen = document.getElementById('welcome-screen');
                    
                    if (welcomeScreen) welcomeScreen.style.display = 'none';
                    if (conversation) {
                        conversation.style.display = 'block';
                        
                        // Use professional renderer if available, otherwise fallback
                        let formattedAnswer;
                        if (this.professionalRenderer) {
                            formattedAnswer = this.professionalRenderer.renderMarkdownContent(answer);
                            console.log('üé® Using professional markdown renderer');
                        } else {
                            formattedAnswer = this.renderMarkdown(answer);
                            console.log('‚ö†Ô∏è Using fallback markdown renderer');
                        }
                        
                        // Create discrete confidence badge
                        const confidencePercent = Math.round((confidence || 0) * 100);
                        const confidenceBadge = confidence > 0.75 ? 
                            `<div class="confidence-indicator">üéØ <strong>${confidencePercent}% Confidence</strong></div>` : 
                            `<span class="confidence-badge" style="background: ${this.getConfidenceColor(confidence)};">${confidencePercent}% CONFIDENCE</span>`;
                        
                        // Add new message pair with enhanced content
                        const messageHtml = `
                            <div class="message user-message animate-in">
                                <div class="message-avatar">üë§</div>
                                <div class="message-content">
                                    <div class="message-text">${this.escapeHtml(query)}</div>
                                </div>
                            </div>
                            <div class="message assistant-message animate-in">
                                <div class="message-avatar">ü§ñ</div>
                                <div class="message-content">
                                    ${formattedAnswer}
                                    ${confidenceBadge}
                                </div>
                            </div>
                        `;
                        
                        // Either append to existing conversation or create new
                        if (conversation.innerHTML.trim() === '') {
                            conversation.innerHTML = messageHtml;
                        } else {
                            conversation.innerHTML += messageHtml;
                        }
                        
                        // Scroll to bottom
                        conversation.scrollTop = conversation.scrollHeight;
                    }
                }

                // Enhanced fallback markdown renderer
                renderMarkdown(text) {
                    if (!text) return '';
                    
                    // Use the ProfessionalContentRenderer for consistency
                    if (this.professionalRenderer) {
                        return this.professionalRenderer.renderMarkdownContent(text);
                    }
                    
                    // Fallback: wrap paragraphs and convert simple bullets
                    let html = text
                        .replace(/^# (.*$)/gim, '<h1 class="md-h1">üìã $1</h1>')
                        .replace(/^## (.*$)/gim, '<h2 class="md-h2">‚ñ∏ $1</h2>')
                        .replace(/^\u2022 (.*$)/gim, '<div class="md-bullet">$1</div>');
                    
                    return `<div class="markdown-content professional-content">${html}</div>`;
                }

                displaySources(sources) {
                    if (!sources || sources.length === 0) return;
                    
                    const conversation = document.getElementById('conversation');
                    if (!conversation) return;

                    // Use professional sources if renderer is available
                    if (this.professionalRenderer && sources[0].internal_link) {
                        this.displayProfessionalSources(sources);
                    } else {
                        this.displaySimpleSources(sources);
                    }
                }

                displayProfessionalSources(sources) {
                    const sourcesContainer = this.createProfessionalSourcesContainer();
                    if (!sourcesContainer || !this.professionalRenderer) return;

                    const sourcesElement = this.professionalRenderer.createCollapsibleSources(sources);
                    sourcesContainer.innerHTML = '';
                    sourcesContainer.appendChild(sourcesElement);
                    
                    // Enhance the professional sources with proper file handling
                    this.enhanceProfessionalSourceButtons(sourcesElement, sources);
                    
                    sourcesContainer.style.display = 'block';
                    
                    console.log('üé® Professional sources rendered with enhanced file handling');
                }

                enhanceProfessionalSourceButtons(sourcesElement, sources) {
                    // Find all source cards and enhance their buttons
                    const sourceCards = sourcesElement.querySelectorAll('.source-card');
                    
                    sourceCards.forEach((card, index) => {
                        if (index < sources.length) {
                            const source = sources[index];
                            const link = source.internal_link || source.filename || source.file_path;
                            const pageNumber = source.page_number || 1;
                            
                            if (link) {
                                // Find existing buttons or create new ones
                                let actionsContainer = card.querySelector('.source-actions');
                                if (!actionsContainer) {
                                    actionsContainer = document.createElement('div');
                                    actionsContainer.className = 'source-actions';
                                    card.appendChild(actionsContainer);
                                }
                                
                                // Create professional PDF viewer button
                                const pdfButton = document.createElement('button');
                                pdfButton.className = 'source-btn primary';
                                pdfButton.innerHTML = 'üìÑ View PDF';
                                pdfButton.title = `Open ${link} at page ${pageNumber}`;
                                pdfButton.onclick = (e) => {
                                    e.preventDefault();
                                    window.searchBar.viewPDF(link, pageNumber);
                                };
                                
                                // Add to actions container
                                actionsContainer.appendChild(pdfButton);
                                
                                // If it's a direct link, also add external link option
                                if (source.internal_link && source.internal_link.startsWith('/documents/')) {
                                    const externalButton = document.createElement('a');
                                    externalButton.className = 'source-btn secondary';
                                    externalButton.innerHTML = 'üîó Direct Link';
                                    externalButton.href = source.internal_link;
                                    externalButton.target = '_blank';
                                    externalButton.title = 'Open in new tab';
                                    
                                    actionsContainer.appendChild(externalButton);
                                }
                            }
                        }
                    });
                }

                displaySimpleSources(sources) {
                    const sourcesContainer = this.createSimpleSourcesContainer();
                    if (!sourcesContainer) return;

                    const sourceCount = Math.min(sources.length, 5);
                    
                    let sourcesHtml = `
                        <div class="sources-header">
                            <span class="sources-count">${sourceCount} source${sourceCount > 1 ? 's' : ''}</span>
                        </div>
                        <div class="sources-list">
                    `;
                    
                    sources.slice(0, 5).forEach((source, index) => {
                        const title = source.title || 'NCDOT Document';
                        const shortTitle = title.length > 50 ? title.substring(0, 47) + '...' : title;
                        const page = source.pages || source.page_number || 'N/A';
                        const year = source.year || '2024';
                        
                        // Use internal_link first, then fallback to filename or file_path
                        const link = source.internal_link || source.filename || source.file_path;
                        const pageNumber = source.page_number || page || 1;
                        
                        sourcesHtml += `
                            <div class="source-item-simple">
                                <span class="source-number">${index + 1}</span>
                                <div class="source-info">
                                    <div class="source-title-simple">${this.escapeHtml(shortTitle)}</div>
                                    <div class="source-meta">Page ${page} ‚Ä¢ ${year}</div>
                                </div>
                                ${link ? 
                                    `<button onclick="window.searchBar.viewPDF('${link}', ${pageNumber})" class="source-link" title="View document" style="background: none; border: none; cursor: pointer; color: var(--color-primary); font-size: var(--font-size-sm);">üìÑ</button>` : 
                                    '<div class="source-placeholder"></div>'
                                }
                            </div>
                        `;
                    });
                    
                    sourcesHtml += '</div>';
                    sourcesContainer.innerHTML = sourcesHtml;
                    sourcesContainer.style.display = 'block';
                }

                createProfessionalSourcesContainer() {
                    const conversation = document.getElementById('conversation');
                    if (!conversation) return null;

                    let sourcesSection = document.querySelector('.sources-section-professional');
                    if (!sourcesSection) {
                        sourcesSection = document.createElement('div');
                        sourcesSection.className = 'sources-section-professional';
                        sourcesSection.style.display = 'none';
                        conversation.parentNode.insertBefore(sourcesSection, conversation.nextSibling);
                    }
                    return sourcesSection;
                }

                createSimpleSourcesContainer() {
                    const conversation = document.getElementById('conversation');
                    if (!conversation) return null;

                    let sourcesSection = document.querySelector('.sources-section-simple');
                    if (!sourcesSection) {
                        sourcesSection = document.createElement('div');
                        sourcesSection.className = 'sources-section-simple';
                        sourcesSection.style.display = 'none';
                        conversation.parentNode.insertBefore(sourcesSection, conversation.nextSibling);
                    }
                    return sourcesSection;
                }

                displayImages(images) {
                    const imageGrid = document.getElementById('image-grid');
                    const imageResults = document.getElementById('image-results');
                    const imagePlaceholder = document.getElementById('image-placeholder');
                    const imageCount = document.getElementById('image-results-count');

                    if (!imageGrid) return;

                    imageGrid.innerHTML = '';
                    
                    if (images.length === 0) {
                        if (imagePlaceholder) imagePlaceholder.style.display = 'block';
                        if (imageResults) imageResults.style.display = 'none';
                        return;
                    }

                    // Update image count
                    if (imageCount) {
                        imageCount.textContent = `${images.length} image${images.length !== 1 ? 's' : ''} found`;
                    }
                    
                    images.forEach((image, index) => {
                        const imageEl = document.createElement('div');
                        imageEl.className = 'image-result';
                        
                        const imagePath = image.web_path || image.thumbnail_path || image.image_path || '';
                        const imageTitle = image.readable_filename || image.original_filename || image.title || 'Untitled Image';
                        const similarity = image.similarity_score ? Math.round(image.similarity_score * 100) : 'N/A';
                        const category = image.teppl_category || image.category || 'general';
                        
                        imageEl.innerHTML = `
                            <div class="image-container" onclick="window.searchBar.viewImage('${imagePath}', '${this.escapeHtml(imageTitle)}')">
                                <img 
                                    src="${imagePath}" 
                                    alt="${this.escapeHtml(imageTitle)}"
                                    loading="lazy"
                                    onerror="this.parentElement.innerHTML='<div class=\\'image-error\\'>‚ùå Failed to load</div>'"
                                />
                                <div class="image-overlay">
                                    <div class="image-relevance">${similarity}%</div>
                                </div>
                            </div>
                            <div class="image-caption">
                                <div class="image-title" title="${this.escapeHtml(imageTitle)}">${this.escapeHtml(imageTitle)}</div>
                                <div class="image-meta">
                                    <span class="image-category">üè∑Ô∏è ${category}</span>
                                    ${image.page_number ? `<span class="image-page">üìÑ Page ${image.page_number}</span>` : ''}
                                </div>
                            </div>
                        `;
                        imageGrid.appendChild(imageEl);
                    });

                    // Show image results
                    if (imagePlaceholder) imagePlaceholder.style.display = 'none';
                    if (imageResults) imageResults.style.display = 'block';
                }

                getConfidenceColor(confidence) {
                    const conf = confidence || 0;
                    if (conf >= 0.8) return '#10B981'; // Green
                    if (conf >= 0.6) return '#F59E0B'; // Yellow
                    if (conf >= 0.4) return '#EF4444'; // Red
                    return '#6B7280'; // Gray
                }

                viewPDF(filePath, page = 1) {
                    console.log('üìñ Opening PDF viewer:', filePath, 'Page:', page);
                    
                    const modal = document.getElementById('document-modal');
                    const pdfContainer = document.getElementById('pdf-container');
                    const pdfViewer = document.getElementById('pdf-viewer');
                    const modalTitle = document.getElementById('document-modal-title');
                    
                    if (!modal || !pdfContainer || !pdfViewer) {
                        console.error('‚ùå PDF viewer elements not found');
                        return;
                    }
                    
                    // Set modal title
                    if (modalTitle) {
                        const fileName = filePath.split('/').pop() || 'Document';
                        modalTitle.textContent = `${fileName} - Page ${page}`;
                    }
                    
                    // Show modal and loading state
                    modal.classList.add('active');
                    pdfContainer.style.display = 'none';
                    pdfViewer.style.display = 'block';
                    
                    // Show loading indicator
                    const loadingIndicator = pdfViewer.querySelector('.loading-indicator');
                    const pdfError = document.getElementById('pdf-error');
                    if (loadingIndicator) loadingIndicator.style.display = 'block';
                    if (pdfError) pdfError.style.display = 'none';
                    
                    // TODO: Implement actual PDF loading with PDF.js
                    // For now, simulate loading and show container
                    setTimeout(() => {
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        pdfViewer.style.display = 'none';
                        pdfContainer.style.display = 'block';
                        
                        // Update page info
                        const pageInfo = document.getElementById('page-info');
                        if (pageInfo) {
                            pageInfo.textContent = `${page} / ${page}`;
                        }
                        
                        console.log('‚úÖ PDF viewer opened successfully');
                    }, 1000);
                }

                goToTEPPLSection(documentId) {
                    console.log('üîó Opening TEPPL section:', documentId);
                    // TODO: Implement TEPPL section navigation
                    alert(`TEPPL Section: ${documentId}\n\nDirect navigation will be implemented in next update.`);
                }

                viewImage(imagePath, title) {
                    console.log('üñºÔ∏è Viewing image:', imagePath);
                    const modal = document.getElementById('image-modal');
                    const content = document.getElementById('image-modal-content');
                    const modalTitle = document.getElementById('image-modal-title');
                    
                    if (modal && content) {
                        modalTitle.textContent = title;
                        content.innerHTML = `
                            <div class="image-viewer">
                                <img src="${imagePath}" alt="${this.escapeHtml(title)}" style="max-width: 100%; max-height: 80vh; object-fit: contain;" />
                            </div>
                        `;
                        modal.classList.add('active');
                    }
                }

                displayError(message) {
                    const conversation = document.getElementById('conversation');
                    const welcomeScreen = document.getElementById('welcome-screen');
                    
                    if (welcomeScreen) welcomeScreen.style.display = 'none';
                    if (conversation) {
                        conversation.style.display = 'block';
                        
                        const errorHtml = `
                            <div class="message error-message animate-in">
                                <div class="message-avatar">‚ö†Ô∏è</div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <span style="color: var(--color-error); font-weight: bold;">‚ùå Error</span>
                                        <span class="message-timestamp">${new Date().toLocaleTimeString()}</span>
                                    </div>
                                    <div class="message-text" style="color: var(--color-error);">
                                        ${this.escapeHtml(message)}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        conversation.innerHTML += errorHtml;
                        conversation.scrollTop = conversation.scrollHeight;
                    }
                }

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                saveToHistory(query) {
                    try {
                        const history = JSON.parse(localStorage.getItem('teppl_search_history') || '[]');
                        if (!history.includes(query)) {
                            history.unshift(query);
                            localStorage.setItem('teppl_search_history', JSON.stringify(history.slice(0, 50)));
                            console.log('üíæ Saved to history:', query);
                        }
                    } catch (error) {
                        console.error('Failed to save to history:', error);
                    }
                }

                // Enhanced utility methods
                formatFileSize(bytes) {
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    if (bytes === 0) return '0 Bytes';
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
                }

                truncateText(text, maxLength = 200) {
                    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
                }

                debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }
            }

            // Working Theme Management
            class ThemeManager {
                constructor() {
                    this.currentTheme = localStorage.getItem('theme') || 'dark';
                    this.init();
                }
                
                init() {
                    this.applyTheme(this.currentTheme);
                    const themeButton = document.getElementById('theme-toggle');
                    if (themeButton) {
                        themeButton.addEventListener('click', () => this.toggle());
                        console.log('‚úÖ Theme toggle initialized');
                    }
                }
                
                applyTheme(theme) {
                    document.documentElement.setAttribute('data-color-scheme', theme);
                    localStorage.setItem('theme', theme);
                    this.currentTheme = theme;
                    
                    const themeButton = document.getElementById('theme-toggle');
                    if (themeButton) {
                        themeButton.innerHTML = theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
                    }
                }
                
                toggle() {
                    const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                    this.applyTheme(newTheme);
                }
            }

            // Working System Info Manager
            class SystemInfoManager {
                constructor() {
                    this.modal = document.getElementById('system-info-modal');
                    this.content = document.getElementById('system-info-content');
                    this.init();
                }

                init() {
                    const systemInfoBtn = document.getElementById('system-info-btn');
                    const closeBtn = document.getElementById('close-system-info');

                    if (systemInfoBtn) {
                        systemInfoBtn.addEventListener('click', () => this.show());
                        console.log('‚úÖ System info button initialized');
                    }
                    
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => this.hide());
                    }

                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.modal?.classList.contains('active')) {
                            this.hide();
                        }
                    });
                }

                show() {
                    if (this.modal) {
                        this.modal.classList.add('active');
                        this.loadSystemInfo();
                    }
                }

                hide() {
                    if (this.modal) {
                        this.modal.classList.remove('active');
                    }
                }

                async loadSystemInfo() {
                    if (!this.content) return;
                    this.content.innerHTML = '<p>Loading system information...</p>';
                    
                    try {
                        const response = await fetch('/api/system-info');
                        const data = await response.json();
                        
                        this.content.innerHTML = `
                            <div class="system-stats">
                                <h4>System Status</h4>
                                <p><strong>Type:</strong> ${data.system_type || 'Unknown'}</p>
                                <p><strong>Multimodal:</strong> ${data.multimodal_available ? 'Yes' : 'No'}</p>
                                
                                <h4>Document Statistics</h4>
                                <p><strong>Total Files:</strong> ${data.file_stats?.total_files || 'N/A'}</p>
                                <p><strong>Total Size:</strong> ${data.file_stats?.total_size_mb || 'N/A'} MB</p>
                                
                                <h4>Last Updated</h4>
                                <p>${new Date().toLocaleString()}</p>
                            </div>
                        `;
                    } catch (error) {
                        console.error('System info error:', error);
                        this.content.innerHTML = '<p>Error loading system information.</p>';
                    }
                }
            }

            // Initialize everything with enhanced integration
            try {
                const searchBar = new SearchBarManager();
                const themeManager = new ThemeManager();
                const systemInfo = new SystemInfoManager();
                
                // Make searchBar globally available
                window.searchBar = searchBar;
                
                // Enhanced modal management
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        e.target.classList.remove('active');
                    }
                });

                // Document viewer modal close functionality
                const closeDocumentModal = document.getElementById('close-document-modal');
                if (closeDocumentModal) {
                    closeDocumentModal.addEventListener('click', () => {
                        const documentModal = document.getElementById('document-modal');
                        if (documentModal) {
                            documentModal.classList.remove('active');
                        }
                    });
                }

                // Image viewer modal close functionality  
                const closeImageModal = document.getElementById('close-image-modal');
                if (closeImageModal) {
                    closeImageModal.addEventListener('click', () => {
                        const imageModal = document.getElementById('image-modal');
                        if (imageModal) {
                            imageModal.classList.remove('active');
                        }
                    });
                }

                // Enhanced keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Escape key closes modals
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                            modal.classList.remove('active');
                        });
                    }
                    
                    // Ctrl/Cmd + Enter submits query
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        const queryForm = document.getElementById('query-form');
                        if (queryForm) {
                            queryForm.dispatchEvent(new Event('submit'));
                        }
                    }
                });
                
                console.log('‚úÖ All core components initialized successfully');
                console.log('üé® Professional interface ready');
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
            }
        });
    </script>

    <!-- Legacy autocomplete fallback -->
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}" defer></script>
    
    <script>
    // Enhanced legacy autocomplete initialization with professional renderer integration
    document.addEventListener('DOMContentLoaded', () => {
        console.log('‚úÖ TEPPL AI Professional Interface loaded');
        
        // Wait for professional renderer to load
        const checkRenderer = () => {
            if (typeof ProfessionalContentRenderer !== 'undefined') {
                console.log('‚úÖ Professional Content Renderer available');
                
                // Test the renderer
                try {
                    const testRenderer = new ProfessionalContentRenderer();
                    const testMarkdown = `# Test Professional Rendering
## Key Requirements  
‚Ä¢ **MUTCD** standards must be followed
‚Ä¢ **NCDOT** approval required`;
                    
                    const result = testRenderer.processMarkdown(testMarkdown);
                    console.log('üß™ Professional renderer test: PASSED');
                    
                    // Make test function available globally
                    window.testProfessionalInterface = () => {
                        console.log('üß™ Testing Professional Interface...');
                        const testDiv = document.createElement('div');
                        testDiv.innerHTML = result;
                        testDiv.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: var(--color-surface);
                            border: 2px solid var(--color-primary);
                            border-radius: var(--radius-lg);
                            padding: var(--space-16);
                            max-width: 400px;
                            z-index: 9999;
                            box-shadow: var(--shadow-xl);
                        `;
                        document.body.appendChild(testDiv);
                        
                        setTimeout(() => testDiv.remove(), 5000);
                        return result;
                    };
                    
                } catch (error) {
                    console.error('‚ùå Professional renderer test: FAILED', error);
                }
            } else {
                console.warn('‚ö†Ô∏è Professional Content Renderer not found - retrying in 100ms');
                setTimeout(checkRenderer, 100);
            }
        };
        
        checkRenderer();
        
        // Initialize legacy autocomplete if available
        if (typeof AutocompleteSystem !== 'undefined' && !window.enhancedAutocompleteLoaded) {
            console.log('üîÑ Initializing legacy autocomplete fallback');
            try {
                new AutocompleteSystem();
                console.log('‚úÖ Legacy autocomplete initialized');
            } catch (error) {
                console.error('‚ùå Legacy autocomplete failed:', error);
            }
        }
    });
    </script>

  <!-- Integrated Search Bar -->
  <script src="{{ url_for('static', filename='js/integrated-search-bar.js') }}"></script>

  <!-- Initialize Professional Interface -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ÔøΩ Initializing Professional Interface‚Ä¶');

      if (typeof ProfessionalContentRenderer !== 'function') {
        console.error('‚ùå ProfessionalContentRenderer missing');
      }
      if (typeof IntegratedSearchBar !== 'function') {
        console.error('‚ùå IntegratedSearchBar missing');
      }
      try {
        // Instantiate the search bar (this will bind the renderer)
        window.searchBar = new IntegratedSearchBar({
          formSelector: '#query-form',
          inputSelector: '#query-input',
          toggleButtonsSelector: '.search-option-toggle'
        });
        console.log('‚úÖ IntegratedSearchBar initialized');
      } catch (e) {
        console.error('‚ùå Failed to init IntegratedSearchBar:', e);
      }
    });
  </script>

  <!-- Remove duplicate legacy includes of professional-content-renderer.js & integrated-search-bar.js below if present -->
<script>
  // Fallback global PDF opener (quick win) if integrated search overrides not yet applied
  window.openPDFQuick = function(link,page){ if(!link) return; window.open(`${link}#page=${page||1}`, '_blank','noopener'); };
  // If searchBar later defines viewPDF, buttons will use it; else patch after load
  document.addEventListener('DOMContentLoaded', ()=>{
    if(window.searchBar && !window.searchBar.viewPDF){
      window.searchBar.viewPDF = (l,p=1)=> window.openPDFQuick(l,p);
    }
  });
</script>
</body>
</html>

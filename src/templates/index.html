<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEPPL AI</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-search-components.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- JavaScript Files -->
    <script src="{{ url_for('static', filename='js/professional-content-renderer.js') }}?v=1.3.2" defer></script>
    <script src="{{ url_for('static', filename='js/integrated-search-bar.js') }}?v=pro120" defer></script>
    <script src="{{ url_for('static', filename='js/ui-shell.js') }}?v=1.0.0" defer></script>
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
    <script>window.pdfjsLib && (pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js');</script>
    
    <!-- Meta tags for better SEO and social sharing -->
    <meta name="description" content="TEPPL AI - Traffic Engineering Assistant for policies, practices, and legal authority documents">
    <meta name="keywords" content="traffic engineering, MUTCD, intersection design, signal timing, NCDOT">
    <meta name="author" content="TEPPL AI">
    
    <!-- Open Graph meta tags -->
    <meta property="og:title" content="TEPPL AI - Traffic Engineering Assistant">
    <meta property="og:description" content="Ask questions about Traffic Engineering policies, practices, and legal authority documents">
    <meta property="og:type" content="website">

    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
</head>
<body>
    <!-- App Header -->
    <div class="app-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">T</div>
                <div class="logo-text">
                    <h1>TEPPL AI</h1>
                    <p>Traffic Engineering Assistant</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="theme-toggle">
                    üåô Dark
                </button>
                <button class="header-btn" id="system-info-btn">
                    üìä System Info
                </button>
            </div>
        </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="main-grid">
        <!-- Left Pane - Enhanced History and Quick Actions -->
        <div id="history-pane" class="pane">
            <div class="pane-header">
                <h2>Search History</h2>
                <button id="clear-history" class="clear-btn" title="Clear search history">Clear</button>
            </div>
            
            <div class="history-content">
                <!-- Enhanced History Search -->
                <div class="history-search-container">
                    <input 
                        type="text" 
                        id="history-search" 
                        class="history-search-input" 
                        placeholder="Search history..." 
                        autocomplete="off"
                        spellcheck="false"
                    />
                </div>
                
                <!-- Enhanced History Results -->
                <div id="history-search-results" class="history-search-results">
                    <!-- Dynamic history search results will be inserted here -->
                </div>
                
                <!-- Original History List (fallback) -->
                <ul class="history-list" id="search-history-list" style="display: none;">
                    <!-- Dynamic history items will be inserted here by legacy code -->
                </ul>
            </div>
            
            <!-- Enhanced Quick Actions Section -->
            <div class="quick-actions">
                <h3>Quick Actions</h3>
                
                <!-- Enhanced Quick Actions Interface -->
                <div class="quick-actions-enhanced">
                    <input 
                        type="text" 
                        id="quick-actions-search" 
                        class="quick-actions-search-input" 
                        placeholder="Search actions..." 
                        autocomplete="off"
                        spellcheck="false"
                    />
                    <button 
                        id="add-custom-action" 
                        class="add-custom-action-btn"
                        title="Add a new custom action"
                    >
                        + Add Custom Action
                    </button>
                    <div id="custom-actions-list" class="custom-actions-list">
                        <!-- Dynamic custom actions will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Pane - Main Interface -->
        <div id="content-pane" class="pane">
            <div class="content-area">
                <!-- Answer Container -->
                <div class="answer-container" id="answer-container">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcome-screen">
                        <div class="welcome-content">
                            <div class="welcome-icon">üõë</div>
                            <h2>Welcome to TEPPL AI</h2>
                            <p>Ask questions about Traffic Engineering policies, practices, and legal authority documents.</p>
                            
                            <!-- Enhanced Status Overview -->
                            <div class="status-overview">
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div>{{ system_type|title if system_type else 'Unknown' }}</div>
                                        <div>Mode</div>
                                    </div>
                                    <div class="status-item">
                                        <div>{{ real_counts.images if real_counts else image_stats.kept_images if image_stats else 0 }}</div>
                                        <div>Images</div>
                                    </div>
                                    <div class="status-item">
                                        <div>{{ real_counts.documents if real_counts else 25 }}</div>
                                        <div>Documents</div>
                                    </div>
                                    <div class="status-item">
                                        <div>{{ real_counts.text_chunks if real_counts else 0 }}</div>
                                        <div>Text Chunks</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Suggestion Cards -->
                            <div class="suggestion-cards">
                                <div class="suggestion-card" data-query="MUTCD sign requirements and placement guidelines" tabindex="0" role="button">
                                    <i>üõë</i>
                                    <div>
                                        <h4>MUTCD Standards</h4>
                                        <p>Sign requirements & placement</p>
                                    </div>
                                </div>
                                <div class="suggestion-card" data-query="Signal timing plans and procedures" tabindex="0" role="button">
                                    <i>üö¶</i>
                                    <div>
                                        <h4>Signal Timing</h4>
                                        <p>Timing plans & procedures</p>
                                    </div>
                                </div>
                                <div class="suggestion-card" data-query="Intersection geometric design standards" tabindex="0" role="button">
                                    <i>‚ö°</i>
                                    <div>
                                        <h4>Intersection Design</h4>
                                        <p>Geometric standards</p>
                                    </div>
                                </div>
                                <div class="suggestion-card" data-query="Show me technical drawings and diagrams" tabindex="0" role="button">
                                    <i>üìê</i>
                                    <div>
                                        <h4>Technical Drawings</h4>
                                        <p>Visual examples & diagrams</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Conversation Container -->
                    <div class="conversation" id="conversation" style="display: none;">
                        <!-- Messages will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Sources Drop-down (renderer expects these IDs) -->
                <section id="sources-section" class="sources-section">
                  <div class="section-header">
                    <button id="sources-toggle" class="sources-dropdown-button">
                      üìö <span id="sources-title">Sources</span>
                      <span id="sources-count" class="pill">0</span>
                      <span class="chevron">‚ñæ</span>
                    </button>
                  </div>
                  <div id="sources-panel" class="sources-dropdown-panel hidden">
                    <ul id="sources-list" class="sources-list"></ul>
                  </div>
                </section>

                <!-- Enhanced Input Container with Integrated Search Options -->
                <div class="input-container">
                    <!-- Integrated Search Options -->
                    <div id="search-options-integrated" class="search-options-integrated">
                        <button 
                            type="button" 
                            class="search-option-toggle" 
                            data-option="images" 
                            aria-pressed="false"
                            title="Include images in search results"
                        >
                            <span class="toggle-icon">üñºÔ∏è</span>
                            <span class="toggle-text">Include images in search</span>
                        </button>
                        <button 
                            type="button" 
                            class="search-option-toggle" 
                            data-option="drawings" 
                            aria-pressed="false"
                            title="Include technical drawings in search results"
                        >
                            <span class="toggle-icon">üìê</span>
                            <span class="toggle-text">Include technical drawings</span>
                        </button>
                    </div>

                    <!-- Enhanced Query Form -->
                    <form id="query-form" class="query-form" role="search">
                        <div class="input-group">
                            <textarea 
                                id="query-input" 
                                name="query"
                                placeholder="Ask about traffic engineering policies, standards, or procedures..."
                                rows="1"
                                maxlength="2000"
                                autocomplete="off"
                                spellcheck="true"
                                aria-label="Enter your question about traffic engineering"
                                required
                            ></textarea>
                            <button 
                                type="submit" 
                                id="send-btn" 
                                class="send-btn" 
                                disabled
                                aria-label="Send query"
                                title="Send your question (or press Enter)"
                            >
                                <span aria-hidden="true">‚Üí</span>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Enhanced Input Footer -->
                    <div class="input-footer">
                        <p class="disclaimer">
                            AI-generated answers may contain errors. Always verify with official NCDOT policies.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Pane - Enhanced Visual Results -->
        <div id="image-pane" class="pane {% if not multimodal_available %}hidden{% endif %}">
            <div class="pane-header">
                <h2>Visual Results</h2>
                <button id="clear-visuals" class="clear-btn" title="Clear visual results">Clear</button>
            </div>
            
            <div class="image-panel">
                <!-- Enhanced Image Placeholder -->
                <div class="image-placeholder" id="image-placeholder">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üñºÔ∏è</div>
                    <p>Images and diagrams will appear here when found in search results</p>
                    <p><em>Enable "Include images in search" to see visual content</em></p>
                </div>
                
                <!-- Enhanced Image Results Container -->
                <div id="image-results" class="image-results" style="display: none;">
                    <div class="image-results-header">
                        <h3>Related Images & Diagrams</h3>
                        <div class="image-results-count" id="image-results-count"></div>
                    </div>
                    <div class="image-grid" id="image-grid">
                        <!-- Dynamic image results will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Autocomplete Dropdown -->
    <div id="autocomplete-dropdown" class="autocomplete-dropdown" style="display: none;" role="listbox">
        <div id="autocomplete-list" class="autocomplete-list">
            <!-- Dynamic autocomplete suggestions will be inserted here -->
        </div>
    </div>

    <!-- System Info Modal -->
    <div id="system-info-modal" class="modal-overlay">
        <div class="modal-container" style="width: 600px; height: auto; max-height: 80vh;">
            <div class="modal-header">
                <h3>System Information</h3>
                <button id="close-system-info" class="modal-close">√ó</button>
            </div>
            <div class="modal-content" style="padding: var(--space-16); overflow-y: auto;">
                <div id="system-info-content">
                    <p>Loading system information...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div class="modal-overlay" id="document-modal" role="dialog" aria-labelledby="document-modal-title" aria-hidden="true">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="document-modal-title">Document Viewer</h3>
                <button class="modal-close" id="close-document-modal" aria-label="Close document viewer">&times;</button>
            </div>
            
            <!-- Enhanced PDF Container -->
            <div id="pdf-container" class="pdf-container" style="display: none;">
                <!-- Enhanced PDF Toolbar -->
                <div class="pdf-toolbar" id="pdf-toolbar">
                    <div class="pdf-controls">
                        <button class="pdf-btn" id="pdf-prev" aria-label="Previous page" title="Previous page">‚Äπ</button>
                        <div class="page-info" id="page-info" role="status" aria-live="polite">1 / 1</div>
                        <button class="pdf-btn" id="pdf-next" aria-label="Next page" title="Next page">‚Ä∫</button>
                    </div>
                    <div class="pdf-zoom-controls">
                        <button class="pdf-btn" id="pdf-zoom-out" aria-label="Zoom out" title="Zoom out">‚àí</button>
                        <span id="pdf-zoom-level">100%</span>
                        <button class="pdf-btn" id="pdf-zoom-in" aria-label="Zoom in" title="Zoom in">+</button>
                    </div>
                </div>
                
                <!-- Enhanced PDF Canvas -->
                <canvas id="pdf-canvas" role="img"></canvas>
            </div>
            
            <!-- Enhanced PDF Viewer -->
            <div class="pdf-viewer" id="pdf-viewer">
                <div class="loading-indicator">
                    <p>Loading document...</p>
                </div>
                <div class="pdf-error" id="pdf-error" style="display: none;" role="alert">
                    <h4>Unable to load document</h4>
                    <p>Please check the console for details or try refreshing the page.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Image Viewer Modal -->
    <div class="modal-overlay" id="image-modal" role="dialog" aria-labelledby="image-modal-title" aria-hidden="true">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="image-modal-title">Image Viewer</h3>
                <button class="modal-close" id="close-image-modal" aria-label="Close image viewer">&times;</button>
            </div>
            <div class="image-modal-content" id="image-modal-content">
                <!-- Image will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Enhanced Custom Action Modal -->
    <div class="modal-overlay" id="custom-action-modal" role="dialog" aria-labelledby="custom-action-modal-title" aria-hidden="true">
        <div class="modal-container" style="width: 500px; height: auto;">
            <div class="modal-header">
                <h3>Add Custom Action</h3>
                <button id="close-modal" class="modal-close" type="button">√ó</button>
            </div>
            <div class="modal-content" style="padding: var(--space-16);">
                <form id="custom-action-form">
                    <div class="form-group" style="margin-bottom: var(--space-12);">
                        <label for="action-name" style="display: block; margin-bottom: var(--space-4); font-weight: var(--font-weight-medium);">Action Name</label>
                        <input type="text" id="action-name" class="form-input" style="width: 100%; padding: var(--space-8); border: 1px solid var(--color-border); border-radius: var(--radius-base);" placeholder="e.g., Traffic Signs" required>
                    </div>
                    <div class="form-group" style="margin-bottom: var(--space-16);">
                        <label for="action-query" style="display: block; margin-bottom: var(--space-4); font-weight: var(--font-weight-medium);">Query</label>
                        <input type="text" id="action-query" class="form-input" style="width: 100%; padding: var(--space-8); border: 1px solid var(--color-border); border-radius: var(--radius-base);" placeholder="e.g., MUTCD sign requirements" required>
                    </div>
                    <div id="form-error" class="form-error" style="display: none;"></div>
                    <div class="form-actions" style="display: flex; gap: var(--space-8); justify-content: flex-end;">
                        <button type="button" id="cancel-action" style="padding: var(--space-8) var(--space-16); background: var(--color-secondary); border: 1px solid var(--color-border); border-radius: var(--radius-base); cursor: pointer;">Cancel</button>
                        <button type="submit" style="padding: var(--space-8) var(--space-16); background: var(--color-primary); color: var(--color-btn-primary-text); border: none; border-radius: var(--radius-base); cursor: pointer;">Add Action</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- RATIONALE:
      The previous ~900 lines of inline JS (SearchBarManager, ThemeManager, SystemInfoManager,
      duplicate rendering + PDF/image handlers) were removed per cleanup instructions to:
        1. Eliminate duplicate event bindings & race conditions (multiple submit handlers firing).
        2. Consolidate logic into modular files:
             - professional-content-renderer.js  (rendering + sources dropdown)
             - integrated-search-bar.js          (single guarded query pipeline)
        3. Prevent stale cached inline code from overriding updated external scripts.
        4. Reduce bundle size & improve maintainability (one source of truth).
      What remains inline:
        - Error handling & session tracking (non-duplicative).
        - Modals & DOM containers required by renderer.
        - Minimal initializer that wires IntegratedSearchBar + renderer.
      If you need Theme/System Info features restored, they should be moved into a small
      dedicated JS file (e.g. js/ui-shell.js) instead of re‚Äëembedding a large inline block.
    -->
    <!-- Enhanced Error Handling and Session Management -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Initializing TEPPL AI Enhanced Features...');

      // Enhanced global error handler
      window.addEventListener('error', (event) => {
        console.error('üí• Global error:', event.error);
        if (event.error && event.error.message && 
            !event.error.message.includes('ResizeObserver') &&
            !event.error.message.includes('Non-Error promise rejection')) {
          if (event.error.message.includes('fetch') || 
              event.error.message.includes('network') ||
              event.error.message.includes('server')) {
            const conversation = document.getElementById('conversation');
            if (conversation && conversation.style.display !== 'none') {
              console.error('Critical error occurred:', event.error.message);
              // Show user-friendly error message
              if (window.searchBar && typeof window.searchBar.displayError === 'function') {
                window.searchBar.displayError('Network connection issue. Please try again.');
              }
            }
          }
        }
      });

      // Enhanced unhandled promise rejection handler
      window.addEventListener('unhandledrejection', (event) => {
        console.error('üí• Unhandled promise rejection:', event.reason);
        if (event.reason && event.reason.toString().includes('fetch')) {
          console.error('Network-related promise rejection:', event.reason);
          // Prevent default browser handling
          event.preventDefault();
        }
      });

      // Enhanced user interaction tracking and session management
      let userInteractionCount = 0;
      ['click', 'keydown', 'input'].forEach(eventType => {
        document.addEventListener(eventType, () => {
          userInteractionCount++;
          if (userInteractionCount === 10) {
            console.log('üë§ User is actively engaged');
          }
        }, { once: false, passive: true });
      });

      const sessionStart = new Date().toISOString();
      sessionStorage.setItem('teppl_session_start', sessionStart);
      
      window.addEventListener('beforeunload', () => {
        const sessionDuration = Date.now() - new Date(sessionStart).getTime();
        console.log('üìä Session duration:', Math.round(sessionDuration / 1000), 'seconds');
        console.log('üìä User interactions:', userInteractionCount);
        
        // Store session analytics
        try {
          const sessionData = {
            duration: Math.round(sessionDuration / 1000),
            interactions: userInteractionCount,
            timestamp: sessionStart,
            endTime: new Date().toISOString()
          };
          localStorage.setItem('teppl_last_session', JSON.stringify(sessionData));
        } catch (e) {
          console.warn('Could not save session data:', e);
        }
      });

      console.log('‚úÖ Enhanced error handling and session management initialized');
    });
  </script>

  <!-- Legacy autocomplete fallback (optional to keep) -->
  <script src="{{ url_for('static', filename='js/autocomplete.js') }}" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const checkRenderer = () => {
        if (typeof ProfessionalContentRenderer !== 'undefined') {
          try {
            const test = new ProfessionalContentRenderer();
            test.renderMarkdownContent?.('# Test\nOK');
          } catch(e){ console.warn('Renderer test failed', e); }
        } else setTimeout(checkRenderer, 120);
      };
      checkRenderer();
    });
  </script>

  <!-- Simple initializer (single source of truth) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof ProfessionalContentRenderer !== 'function') console.error('Renderer missing');
      if (typeof IntegratedSearchBar !== 'function') console.error('Search bar missing');
      try {
        window.searchBar = new IntegratedSearchBar({
          formSelector: '#query-form',
            inputSelector: '#query-input',
            toggleButtonsSelector: '.search-option-toggle'
        });
      } catch(e){
        console.error('Failed to initialize IntegratedSearchBar', e);
      }
    });
  </script>

  <!-- Fallback PDF opener -->
  <script>
    window.openPDFQuick = function(link,page){ if(!link) return; window.open(`${link}#page=${page||1}`,'_blank','noopener'); };
    document.addEventListener('DOMContentLoaded', () => {
      if (window.searchBar && !window.searchBar.viewPDF) {
        window.searchBar.viewPDF = (l,p=1)=> window.openPDFQuick(l,p);
      }
    });
  </script>
</body>
</html>
